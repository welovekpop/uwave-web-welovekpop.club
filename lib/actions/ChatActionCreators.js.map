{"version":3,"sources":["actions/ChatActionCreators.js"],"names":["receiveMotd","log","prepareMessage","sendChat","inputMessage","receive","removeMessage","removeMessagesByUser","removeAllMessages","muteUser","unmuteUser","setMotdStart","setMotdComplete","setMotd","text","type","payload","logIdx","Date","now","_id","state","user","parseOpts","arguments","length","undefined","parsed","message","dispatch","getState","sender","hasRole","mute","timeLeft","expiresAt","long","users","mentions","concat","map","username","_splitargs","slice","command","params","result","isMuted","userID","indexOf","settings","currentUser","senderHasRole","mention","isMention","mentionSound","id","expireMute","_ref","moderatorID","currentTime","expireIn","expirationTimer","setTimeout","_ref2","muteTimeouts","clearTimeout","motd","onStart","onComplete","_ref3","data","onError","error"],"mappings":";;;;;QAiBgBA,W,GAAAA,W;QAQAC,G,GAAAA,G;QAWAC,c,GAAAA,c;QAeAC,Q,GAAAA,Q;QAsBAC,Y,GAAAA,Y;QAuBAC,O,GAAAA,O;QA6CAC,a,GAAAA,a;QAOAC,oB,GAAAA,oB;QAOAC,iB,GAAAA,iB;QAaAC,Q,GAAAA,Q;QAsBAC,U,GAAAA,U;QAeAC,Y,GAAAA,Y;QAOAC,e,GAAAA,e;QAOAC,O,GAAAA,O;;AA3NhB;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;AAEA;;;;AAEO,SAASb,WAAT,CAAqBc,IAArB,EAA2B;AAChC,SAAO;AACLC,4BADK;AAELC,aAASF;AAFJ,GAAP;AAID;;AAED,IAAIG,SAASC,KAAKC,GAAL,EAAb;AACO,SAASlB,GAAT,CAAaa,IAAb,EAAmB;AACxBG,YAAU,CAAV;AACA,SAAO;AACLF,mBADK;AAELC,aAAS;AACPI,WAAKH,MADE;AAEPH,YAAMA;AAFC;AAFJ,GAAP;AAOD;;AAEM,SAASZ,cAAT,CAAwBmB,KAAxB,EAA+BC,IAA/B,EAAqCR,IAArC,EAA2C;AAChD,MAAIS,YAAYC,UAAUC,MAAV,GAAmB,CAAnB,IAAwBD,UAAU,CAAV,MAAiBE,SAAzC,GAAqDF,UAAU,CAAV,CAArD,GAAoE,EAApF;;AAEA,MAAIG,SAAS,oCAAgBb,IAAhB,EAAsBS,SAAtB,CAAb;AACA,qCAAgBI,MAAhB,EAAwBN,KAAxB;AACA,SAAO;AACLN,4BADK;AAELC,aAAS;AACPM,YAAMA,IADC;AAEPM,eAASd,IAFF;AAGPa,cAAQA;AAHD;AAFJ,GAAP;AAQD;;AAEM,SAASxB,QAAT,CAAkBW,IAAlB,EAAwB;AAC7B,SAAO,UAAUe,QAAV,EAAoBC,QAApB,EAA8B;AACnC,QAAIT,QAAQS,UAAZ;AACA,QAAIC,SAAS,wCAAoBV,KAApB,CAAb;AACA,QAAIW,UAAU,+CAA2BX,KAA3B,CAAd;AACA,QAAIY,OAAO,4CAAwBZ,KAAxB,CAAX;AACA,QAAIY,IAAJ,EAAU;AACR,UAAIC,WAAW,kBAAGD,KAAKE,SAAL,GAAiBjB,KAAKC,GAAL,EAApB,EAAgC,EAAEiB,MAAM,IAAR,EAAhC,CAAf;AACAP,eAAS5B,IAAI,sDAAsDiC,QAAtD,GAAiE,GAArE,CAAT;AACA;AACD;;AAED,QAAIG,QAAQ,qCAAiBhB,KAAjB,CAAZ;AACA,QAAIO,UAAU1B,eAAemB,KAAf,EAAsBU,MAAtB,EAA8BjB,IAA9B,EAAoC;AAChDwB,gBAAU,GAAGC,MAAH,CAAUF,MAAMG,GAAN,CAAU,UAAUlB,IAAV,EAAgB;AAC5C,eAAOA,KAAKmB,QAAZ;AACD,OAFmB,CAAV,EAEN,6CAA0BT,OAA1B,CAFM;AADsC,KAApC,CAAd;AAKAH,aAASD,OAAT;AACD,GAlBD;AAmBD;;AAEM,SAASxB,YAAT,CAAsBU,IAAtB,EAA4B;AACjC,SAAO,UAAUe,QAAV,EAAoBC,QAApB,EAA8B;AACnC,QAAIhB,KAAK,CAAL,MAAY,GAAhB,EAAqB;AACnB,UAAI4B,aAAa,yBAAU5B,KAAK6B,KAAL,CAAW,CAAX,CAAV,CAAjB;AAAA,UACIC,UAAUF,WAAW,CAAX,CADd;AAAA,UAEIG,SAASH,WAAWC,KAAX,CAAiB,CAAjB,CAFb;;AAIA,UAAIC,OAAJ,EAAa;AACX,YAAIE,SAAS,2BAAQhB,UAAR,EAAoBc,OAApB,EAA6BC,MAA7B,CAAb;AACA,YAAIC,MAAJ,EAAY;AACVjB,mBAASiB,MAAT;AACD;AACD;AACD;AACF;AACDjB,aAAS1B,SAASW,IAAT,CAAT;AACD,GAfD;AAgBD;;AAED,SAASiC,OAAT,CAAiB1B,KAAjB,EAAwB2B,MAAxB,EAAgC;AAC9B,SAAO,yCAAqB3B,KAArB,EAA4B4B,OAA5B,CAAoCD,MAApC,MAAgD,CAAC,CAAxD;AACD;;AAEM,SAAS3C,OAAT,CAAiBuB,OAAjB,EAA0B;AAC/B,SAAO,UAAUC,QAAV,EAAoBC,QAApB,EAA8B;AACnC,QAAIT,QAAQS,UAAZ;AACA,QAAIoB,WAAW,wCAAiB7B,KAAjB,CAAf;AACA,QAAI8B,cAAc,wCAAoB9B,KAApB,CAAlB;AACA,QAAIgB,QAAQ,qCAAiBhB,KAAjB,CAAZ;AACA,QAAIU,SAAS,yBAAKM,KAAL,EAAY,UAAUf,IAAV,EAAgB;AACvC,aAAOA,KAAKF,GAAL,KAAaQ,QAAQoB,MAA5B;AACD,KAFY,CAAb;AAGA,QAAII,gBAAgB,wCAAoB/B,KAApB,EAA2BU,MAA3B,CAApB;AACA,QAAIO,WAAW,GAAGC,MAAH,CAAUF,MAAMG,GAAN,CAAU,UAAUlB,IAAV,EAAgB;AACjD,aAAOA,KAAKmB,QAAZ;AACD,KAFwB,CAAV,EAEX,6CAA0B,UAAUY,OAAV,EAAmB;AAC/C,aAAOD,cAAc,kBAAkBC,OAAhC,CAAP;AACD,KAFG,CAFW,CAAf;;AAMA,QAAIN,QAAQ1B,KAAR,EAAeO,QAAQoB,MAAvB,CAAJ,EAAoC;AAClC;AACD;;AAED,QAAIrB,SAAS,oCAAgBC,QAAQd,IAAxB,EAA8B,EAAEwB,UAAUA,QAAZ,EAA9B,CAAb;AACA,uCAAgBX,MAAhB,EAAwBN,KAAxB;;AAEA,QAAIiC,YAAYH,cAAc,8BAAWxB,MAAX,EAAmBwB,YAAY/B,GAA/B,CAAd,GAAoD,KAApE;;AAEAS,aAAS;AACPd,iCADO;AAEPC,eAAS;AACPY,iBAAS,uBAAS,EAAT,EAAaA,OAAb,EAAsB;AAC7BN,gBAAMS;AADuB,SAAtB,CADF;AAIPuB,mBAAWA,SAJJ;AAKP3B,gBAAQA;AALD;AAFF,KAAT;;AAWA,QAAI2B,SAAJ,EAAe;AACb,UAAIJ,SAASK,YAAb,EAA2B;AACzB;AACD;AACD,wCAAmB,kBAAkBxB,OAAOU,QAA5C;AACD;AACF,GAzCD;AA0CD;;AAEM,SAASnC,aAAT,CAAuBkD,EAAvB,EAA2B;AAChC,SAAO;AACLzC,8BADK;AAELC,aAAS,EAAEI,KAAKoC,EAAP;AAFJ,GAAP;AAID;;AAEM,SAASjD,oBAAT,CAA8ByC,MAA9B,EAAsC;AAC3C,SAAO;AACLjC,oCADK;AAELC,aAAS,EAAEgC,QAAQA,MAAV;AAFJ,GAAP;AAID;;AAEM,SAASxC,iBAAT,GAA6B;AAClC,SAAO;AACLO;AADK,GAAP;AAGD;;AAED,SAAS0C,UAAT,CAAoBT,MAApB,EAA4B;AAC1B,SAAO;AACLjC,2BADK;AAELC,aAAS,EAAEgC,QAAQA,MAAV;AAFJ,GAAP;AAID;;AAEM,SAASvC,QAAT,CAAkBuC,MAAlB,EAA0BU,IAA1B,EAAgC;AACrC,MAAIC,cAAcD,KAAKC,WAAvB;AAAA,MACIxB,YAAYuB,KAAKvB,SADrB;;AAGA,SAAO,UAAUN,QAAV,EAAoBC,QAApB,EAA8B;AACnC,QAAI8B,cAAc,wCAAoB9B,UAApB,CAAlB;AACA,QAAI+B,WAAW1B,YAAYyB,WAA3B;;AAEA/B,aAAS;AACPd,2BADO;AAEPC,eAAS;AACPgC,gBAAQA,MADD;AAEPW,qBAAaA,WAFN;AAGPxB,mBAAWA,SAHJ;AAIP2B,yBAAiBD,WAAW,CAAX,GAAeE,WAAW,YAAY;AACrD,iBAAOlC,SAAS4B,WAAWT,MAAX,CAAT,CAAP;AACD,SAF+B,EAE7Ba,QAF6B,CAAf,GAEF;AANR;AAFF,KAAT;AAWD,GAfD;AAgBD;;AAEM,SAASnD,UAAT,CAAoBsC,MAApB,EAA4BgB,KAA5B,EAAmC;AACxC,MAAIL,cAAcK,MAAML,WAAxB;;AAEA,SAAO,UAAU9B,QAAV,EAAoBC,QAApB,EAA8B;AACnC,QAAImC,eAAe,yCAAqBnC,UAArB,CAAnB;AACA,QAAImC,gBAAgBA,aAAajB,MAAb,CAApB,EAA0C;AACxCkB,mBAAaD,aAAajB,MAAb,CAAb;AACD;AACDnB,aAAS;AACPd,6BADO;AAEPC,eAAS,EAAEgC,QAAQA,MAAV,EAAkBW,aAAaA,WAA/B;AAFF,KAAT;AAID,GATD;AAUD;;AAEM,SAAShD,YAAT,CAAsBwD,IAAtB,EAA4B;AACjC,SAAO;AACLpD,8BADK;AAELC,aAASmD;AAFJ,GAAP;AAID;;AAEM,SAASvD,eAAT,CAAyBuD,IAAzB,EAA+B;AACpC,SAAO;AACLpD,iCADK;AAELC,aAASmD;AAFJ,GAAP;AAID;;AAEM,SAAStD,OAAT,CAAiBC,IAAjB,EAAuB;AAC5B,SAAO,gCAAI,OAAJ,EAAa,EAAEqD,MAAMrD,IAAR,EAAb,EAA6B;AAClCsD,aAAS,SAASA,OAAT,GAAmB;AAC1B,aAAOzD,aAAaG,IAAb,CAAP;AACD,KAHiC;AAIlCuD,gBAAY,SAASA,UAAT,CAAoBC,KAApB,EAA2B;AACrC,UAAIC,OAAOD,MAAMC,IAAjB;AACA,aAAO,UAAU1C,QAAV,EAAoB;AACzBA,iBAASjB,gBAAgB2D,KAAKJ,IAArB,CAAT;AACAtC,iBAAS5B,IAAI,gCAAgCsE,KAAKJ,IAAzC,CAAT;AACD,OAHD;AAID,KAViC;AAWlCK,aAAS,SAASA,OAAT,CAAiBC,KAAjB,EAAwB;AAC/B,aAAO;AACL1D,qCADK;AAEL0D,eAAO,IAFF;AAGLzD,iBAASyD;AAHJ,OAAP;AAKD;AAjBiC,GAA7B,CAAP;AAmBD;AACD","file":"ChatActionCreators.js","sourcesContent":["import find from 'array-find';\nimport ms from 'ms';\nimport splitargs from 'splitargs';\nimport parseChatMarkup from 'u-wave-parse-chat-markup';\nimport flashDocumentTitle from 'flash-document-title';\nimport playMentionSound from '../utils/playMentionSound';\nimport {\n  RECEIVE_MOTD,\n  SET_MOTD_START,\n  SET_MOTD_COMPLETE,\n\n  SEND_MESSAGE,\n  RECEIVE_MESSAGE,\n\n  LOG,\n\n  REMOVE_MESSAGE,\n  REMOVE_USER_MESSAGES,\n  REMOVE_ALL_MESSAGES,\n\n  MUTE_USER,\n  UNMUTE_USER,\n} from '../constants/actionTypes/chat';\nimport { put } from './RequestActionCreators';\nimport { execute } from '../utils/ChatCommands';\nimport {\n  muteTimeoutsSelector,\n  mutedUserIDsSelector,\n  currentUserMuteSelector,\n} from '../selectors/chatSelectors';\nimport { settingsSelector } from '../selectors/settingSelectors';\nimport {\n  currentUserSelector,\n  userListSelector,\n  userHasRoleSelector,\n  currentUserHasRoleSelector,\n} from '../selectors/userSelectors';\nimport { currentTimeSelector } from '../selectors/timeSelectors';\n\nimport {\n  getAvailableGroupMentions,\n  resolveMentions,\n  hasMention,\n} from '../utils/chatMentions';\n\nexport function receiveMotd(text) {\n  return {\n    type: RECEIVE_MOTD,\n    payload: text,\n  };\n}\n\nlet logIdx = Date.now();\nexport function log(text) {\n  logIdx += 1;\n  return {\n    type: LOG,\n    payload: {\n      _id: logIdx,\n      text,\n    },\n  };\n}\n\nexport function prepareMessage(state, user, text, parseOpts = {}) {\n  const parsed = parseChatMarkup(text, parseOpts);\n  resolveMentions(parsed, state);\n  return {\n    type: SEND_MESSAGE,\n    payload: {\n      user,\n      message: text,\n      parsed,\n    },\n  };\n}\n\nexport function sendChat(text) {\n  return (dispatch, getState) => {\n    const state = getState();\n    const sender = currentUserSelector(state);\n    const hasRole = currentUserHasRoleSelector(state);\n    const mute = currentUserMuteSelector(state);\n    if (mute) {\n      const timeLeft = ms(mute.expiresAt - Date.now(), { long: true });\n      dispatch(log(`You have been muted, and cannot chat for another ${timeLeft}.`));\n      return;\n    }\n\n    const users = userListSelector(state);\n    const message = prepareMessage(state, sender, text, {\n      mentions: [\n        ...users.map(user => user.username),\n        ...getAvailableGroupMentions(hasRole),\n      ],\n    });\n    dispatch(message);\n  };\n}\n\nexport function inputMessage(text) {\n  return (dispatch, getState) => {\n    if (text[0] === '/') {\n      const [command, ...params] = splitargs(text.slice(1));\n      if (command) {\n        const result = execute(getState(), command, params);\n        if (result) {\n          dispatch(result);\n        }\n        return;\n      }\n    }\n    dispatch(sendChat(text));\n  };\n}\n\nfunction isMuted(state, userID) {\n  return mutedUserIDsSelector(state).indexOf(userID) !== -1;\n}\n\nexport function receive(message) {\n  return (dispatch, getState) => {\n    const state = getState();\n    const settings = settingsSelector(state);\n    const currentUser = currentUserSelector(state);\n    const users = userListSelector(state);\n    const sender = find(users, user => user._id === message.userID);\n    const senderHasRole = userHasRoleSelector(state)(sender);\n    const mentions = [\n      ...users.map(user => user.username),\n      ...getAvailableGroupMentions(mention => senderHasRole(`chat.mention.${mention}`)),\n    ];\n\n    if (isMuted(state, message.userID)) {\n      return;\n    }\n\n    const parsed = parseChatMarkup(message.text, { mentions });\n    resolveMentions(parsed, state);\n\n    const isMention = currentUser ? hasMention(parsed, currentUser._id) : false;\n\n    dispatch({\n      type: RECEIVE_MESSAGE,\n      payload: {\n        message: {\n          ...message,\n          user: sender,\n        },\n        isMention,\n        parsed,\n      },\n    });\n\n    if (isMention) {\n      if (settings.mentionSound) {\n        playMentionSound();\n      }\n      flashDocumentTitle(`ðŸ’¬ ${sender.username}`);\n    }\n  };\n}\n\nexport function removeMessage(id) {\n  return {\n    type: REMOVE_MESSAGE,\n    payload: { _id: id },\n  };\n}\n\nexport function removeMessagesByUser(userID) {\n  return {\n    type: REMOVE_USER_MESSAGES,\n    payload: { userID },\n  };\n}\n\nexport function removeAllMessages() {\n  return {\n    type: REMOVE_ALL_MESSAGES,\n  };\n}\n\nfunction expireMute(userID) {\n  return {\n    type: UNMUTE_USER,\n    payload: { userID },\n  };\n}\n\nexport function muteUser(userID, { moderatorID, expiresAt }) {\n  return (dispatch, getState) => {\n    const currentTime = currentTimeSelector(getState());\n    const expireIn = expiresAt - currentTime;\n\n    dispatch({\n      type: MUTE_USER,\n      payload: {\n        userID,\n        moderatorID,\n        expiresAt,\n        expirationTimer: expireIn > 0 ?\n          setTimeout(() => dispatch(expireMute(userID)), expireIn) : null,\n      },\n    });\n  };\n}\n\nexport function unmuteUser(userID, { moderatorID }) {\n  return (dispatch, getState) => {\n    const muteTimeouts = muteTimeoutsSelector(getState());\n    if (muteTimeouts && muteTimeouts[userID]) {\n      clearTimeout(muteTimeouts[userID]);\n    }\n    dispatch({\n      type: UNMUTE_USER,\n      payload: { userID, moderatorID },\n    });\n  };\n}\n\nexport function setMotdStart(motd) {\n  return {\n    type: SET_MOTD_START,\n    payload: motd,\n  };\n}\n\nexport function setMotdComplete(motd) {\n  return {\n    type: SET_MOTD_COMPLETE,\n    payload: motd,\n  };\n}\n\nexport function setMotd(text) {\n  return put('/motd', { motd: text }, {\n    onStart: () => setMotdStart(text),\n    onComplete: ({ data }) => (dispatch) => {\n      dispatch(setMotdComplete(data.motd));\n      dispatch(log(`Message of the Day is now: ${data.motd}`));\n    },\n    onError: error => ({\n      type: SET_MOTD_COMPLETE,\n      error: true,\n      payload: error,\n    }),\n  });\n}\n"]}