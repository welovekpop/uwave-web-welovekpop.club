{"version":3,"sources":["store/socket.js"],"names":["debug","defaultUrl","loc","window","location","port","protocol","hostname","actions","chatMessage","_ref","id","userID","message","timestamp","_id","text","chatDelete","chatDeleteByID","_ref2","chatDeleteByUser","_ref3","chatMute","_ref4","expiresAt","moderatorID","chatUnmute","_ref5","advance","booth","skip","_ref6","reason","favorite","_ref7","historyID","vote","_ref8","value","waitlistJoin","_ref9","waitlist","waitlistLeave","_ref10","waitlistUpdate","waitlistLock","_ref11","locked","waitlistMove","_ref12","position","waitlistAdd","_ref13","waitlistRemove","_ref14","waitlistClear","playlistCycle","_ref15","playlistID","join","user","leave","nameChange","_ref16","username","guests","receiveGuestCount","aclAllow","_ref17","roles","aclDisallow","_ref18","wlkShouldRandomize","_ref19","type","SHOULD_RANDOMIZE","payload","middleware","_temp","_ref20","_ref20$url","url","_ref21","dispatch","getState","socket","queue","sentAuthToken","opened","isOpen","sendAuthToken","tokne","send","maybeAuthenticateOnConnect","state","auth","then","_ref22","socketToken","command","data","JSON","stringify","push","drainQueuedMessages","messages","forEach","msg","onOpen","SOCKET_CONNECTED","onClose","SOCKET_DISCONNECTED","onMessage","pack","_JSON$parse","parse","action","next","error","SOCKET_RECONNECT","close","undefined","keepClosed","SOCKET_CONNECT","WebSocket","addEventListener","SEND_MESSAGE","DO_UPVOTE","DO_DOWNVOTE","LOGIN_COMPLETE","LOGOUT_START"],"mappings":"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","file":"socket.js","sourcesContent":["import createDebug from 'debug';\nimport WebSocket from 'reconnecting-websocket';\n\nimport {\n  LOGIN_COMPLETE,\n  LOGOUT_START,\n  SOCKET_CONNECT,\n  SOCKET_RECONNECT,\n  SOCKET_DISCONNECTED,\n  SOCKET_CONNECTED,\n} from '../constants/actionTypes/auth';\nimport { SEND_MESSAGE } from '../constants/actionTypes/chat';\nimport {\n  DO_UPVOTE,\n  DO_DOWNVOTE,\n} from '../constants/actionTypes/votes';\nimport { SHOULD_RANDOMIZE } from '../_wlk/constants';\n\nimport { getSocketAuthToken } from '../actions/LoginActionCreators';\nimport {\n  advance,\n  skipped,\n} from '../actions/BoothActionCreators';\nimport {\n  receive as chatReceive,\n  removeMessage,\n  removeMessagesByUser,\n  removeAllMessages,\n  muteUser as chatMute,\n  unmuteUser as chatUnmute,\n} from '../actions/ChatActionCreators';\nimport { cyclePlaylist } from '../actions/PlaylistActionCreators';\nimport {\n  join as userJoin,\n  leave as userLeave,\n  changeUsername,\n  addUserRoles,\n  removeUserRoles,\n  receiveGuestCount,\n} from '../actions/UserActionCreators';\nimport {\n  clearWaitlist,\n  joinedWaitlist,\n  leftWaitlist,\n  updatedWaitlist,\n  movedInWaitlist,\n  setLocked as setWaitlistLocked,\n} from '../actions/WaitlistActionCreators';\nimport { favorited, receiveVote } from '../actions/VoteActionCreators';\n\nconst debug = createDebug('uwave:websocket');\n\nfunction defaultUrl() {\n  const loc = window.location;\n  const port = loc.port || (loc.protocol === 'https:' ? 443 : 80);\n  const protocol = loc.protocol === 'https:' ? 'wss:' : 'ws:';\n  return `${protocol}//${loc.hostname}:${port}`;\n}\n\nconst actions = {\n  chatMessage({\n    id, userID, message, timestamp,\n  }) {\n    return chatReceive({\n      _id: id,\n      userID,\n      text: message,\n      timestamp,\n    });\n  },\n  chatDelete() {\n    return removeAllMessages();\n  },\n  chatDeleteByID({ _id }) {\n    return removeMessage(_id);\n  },\n  chatDeleteByUser({ userID }) {\n    return removeMessagesByUser(userID);\n  },\n  chatMute({ userID, expiresAt, moderatorID }) {\n    return chatMute(userID, { moderatorID, expiresAt });\n  },\n  chatUnmute({ userID, moderatorID }) {\n    return chatUnmute(userID, { moderatorID });\n  },\n  advance(booth) {\n    return advance(booth);\n  },\n  skip({ userID, moderatorID, reason }) {\n    return skipped({ userID, moderatorID, reason });\n  },\n  favorite({ userID, historyID }) {\n    return favorited({ userID, historyID });\n  },\n  vote({ _id, value }) {\n    return receiveVote({ userID: _id, vote: value });\n  },\n  waitlistJoin({ userID, waitlist }) {\n    return joinedWaitlist({ userID, waitlist });\n  },\n  waitlistLeave({ userID, waitlist }) {\n    return leftWaitlist({ userID, waitlist });\n  },\n  waitlistUpdate(waitlist) {\n    return updatedWaitlist(waitlist);\n  },\n  waitlistLock({ locked }) {\n    return setWaitlistLocked(locked);\n  },\n  waitlistMove({\n    userID, moderatorID, position, waitlist,\n  }) {\n    return movedInWaitlist({\n      userID, moderatorID, position, waitlist,\n    });\n  },\n  // TODO Treat moderator force-add and force-remove differently from voluntary\n  // joins and leaves.\n  waitlistAdd({ userID, waitlist }) {\n    return joinedWaitlist({ userID, waitlist });\n  },\n  waitlistRemove({ userID, waitlist }) {\n    return leftWaitlist({ userID, waitlist });\n  },\n  waitlistClear() {\n    return clearWaitlist();\n  },\n  playlistCycle({ playlistID }) {\n    return cyclePlaylist(playlistID);\n  },\n  join(user) {\n    return userJoin(user);\n  },\n  leave(userID) {\n    return userLeave(userID);\n  },\n  nameChange({ userID, username }) {\n    return changeUsername(userID, username);\n  },\n  guests: receiveGuestCount,\n  'acl:allow': ({ userID, roles }) =>\n    addUserRoles(userID, roles),\n  'acl:disallow': ({ userID, roles }) =>\n    removeUserRoles(userID, roles),\n  'wlk:shouldRandomize': ({ value }) => ({\n    type: SHOULD_RANDOMIZE,\n    payload: value,\n  }),\n};\n\nexport default function middleware({ url = defaultUrl() } = {}) {\n  return ({ dispatch, getState }) => {\n    let socket;\n    let queue = [];\n    let sentAuthToken = false;\n    let opened = false;\n\n    function isOpen() {\n      return socket && opened;\n    }\n\n    function sendAuthToken(tokne) {\n      socket.send(tokne);\n      sentAuthToken = true;\n    }\n\n    function maybeAuthenticateOnConnect(state) {\n      const { user } = state.auth;\n      if (!user) return;\n      debug('open', user.id);\n\n      dispatch(getSocketAuthToken()).then(({ socketToken }) => {\n        if (socketToken) {\n          sendAuthToken(socketToken);\n        } else {\n          sentAuthToken = false;\n        }\n      });\n    }\n\n    function send(command, data) {\n      if (isOpen()) {\n        socket.send(JSON.stringify({ command, data }));\n      } else {\n        queue.push({ command, data });\n      }\n    }\n\n    function drainQueuedMessages() {\n      const messages = queue;\n      queue = [];\n      messages.forEach((msg) => {\n        send(msg.command, msg.data);\n      });\n    }\n\n    function onOpen() {\n      opened = true;\n      dispatch({ type: SOCKET_CONNECTED });\n      maybeAuthenticateOnConnect(getState());\n    }\n\n    function onClose() {\n      opened = false;\n      dispatch({ type: SOCKET_DISCONNECTED });\n    }\n\n    function onMessage(pack) {\n      // Ignore keepalive messages.\n      if (pack.data === '-') return;\n\n      const { command, data } = JSON.parse(pack.data);\n      debug(command, data);\n\n      if (command === 'authenticated') {\n        drainQueuedMessages();\n        return;\n      }\n\n      if (typeof actions[command] === 'function') {\n        const action = actions[command](data);\n        if (action) {\n          dispatch(action);\n          return;\n        }\n      }\n      debug('!unknown socket message type');\n    }\n\n    return next => (action) => {\n      const { type, payload, error } = action;\n\n      if (error) {\n        next(action);\n        return;\n      }\n\n      switch (type) {\n        case SOCKET_RECONNECT:\n          if (socket) {\n            socket.close(undefined, undefined, { keepClosed: true });\n          }\n        // fall through\n        case SOCKET_CONNECT:\n          socket = new WebSocket(url);\n          socket.addEventListener('message', onMessage);\n          socket.addEventListener('open', onOpen);\n          socket.addEventListener('close', onClose);\n          socket.addEventListener('connecting', onClose);\n          break;\n        case SEND_MESSAGE:\n          send('sendChat', payload.message);\n          break;\n        case DO_UPVOTE:\n          send('vote', 1);\n          break;\n        case DO_DOWNVOTE:\n          send('vote', -1);\n          break;\n        case LOGIN_COMPLETE:\n          if (!sentAuthToken && isOpen()) {\n            sendAuthToken(payload.socketToken);\n          }\n          break;\n        case LOGOUT_START:\n          sentAuthToken = false;\n          send('logout', null);\n          break;\n        default:\n          break;\n      }\n      next(action);\n    };\n  };\n}\n"]}