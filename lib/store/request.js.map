{"version":3,"sources":["store/request.js"],"names":["middleware","isEmpty","object","Object","keys","length","makeUrl","path","params","arguments","undefined","uri","indexOf","rejectNonOK","response","status","json","then","res","Error","errors","error","map","err","title","join","defaultOptions","apiUrl","middlewareOptions","_ref","dispatch","getState","next","action","type","opts","token","_action$payload","payload","method","url","qs","data","_action$meta","meta","id","onStart","onComplete","onError","completedMeta","requestUrl","requestOptions","headers","Accept","credentials","Authorization","body","JSON","stringify","fetch","responseValue","catch"],"mappings":"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","file":"request.js","sourcesContent":["import assign from 'object-assign';\nimport { stringify as stringifyQS } from 'querystring';\n\nimport { REQUEST_START } from '../constants/actionTypes/request';\nimport {\n  requestComplete,\n  requestCompleteError\n} from '../actions/RequestActionCreators';\nimport { requestOptionsSelector } from '../selectors/configSelectors';\nimport { tokenSelector } from '../selectors/userSelectors';\n\nfunction isEmpty(object) {\n  return !object || Object.keys(object).length === 0;\n}\n\nfunction makeUrl(path, params = {}) {\n  let uri = path;\n\n  if (!isEmpty(params)) {\n    // hehâ€¦\n    uri += (uri.indexOf('?') !== -1 ? '&' : '?') + stringifyQS(params);\n  }\n\n  return uri;\n}\n\nfunction rejectNonOK(response) {\n  if (response.status !== 200) {\n    return response.json().then((res) => {\n      if (!('errors' in res)) {\n        throw new Error('An unknown error occurred.');\n      }\n      const { errors } = res;\n      const error = assign(new Error(\n        errors.map(err => err.title).join(', ')\n      ), {\n        response,\n        errors\n      });\n      throw error;\n    });\n  }\n  return response;\n}\n\nconst defaultOptions = {\n  apiUrl: '/v1'\n};\n\nexport default function middleware(middlewareOptions = {}) {\n  return ({ dispatch, getState }) => next => (action) => {\n    if (action.type !== REQUEST_START) {\n      return next(action);\n    }\n\n    const opts = {\n      ...defaultOptions,\n      ...middlewareOptions,\n      ...requestOptionsSelector(getState())\n    };\n\n    const token = tokenSelector(getState());\n    const {\n      method,\n      url,\n      qs,\n      data\n    } = action.payload;\n    const {\n      id,\n      onStart,\n      onComplete,\n      onError\n    } = action.meta;\n\n    const completedMeta = {\n      id,\n      method,\n      url,\n      qs,\n      data\n    };\n\n    const requestUrl = makeUrl(opts.apiUrl + url, qs);\n\n    const requestOptions = {\n      method,\n      headers: {\n        Accept: 'application/json',\n        'Content-Type': 'application/json'\n      },\n      credentials: 'same-origin'\n    };\n\n    if (token) {\n      requestOptions.headers.Authorization = `JWT ${token}`;\n    }\n\n    if (method !== 'get') {\n      requestOptions.body = JSON.stringify(data);\n    }\n\n    if (onStart) {\n      dispatch(onStart());\n    }\n\n    return fetch(requestUrl, requestOptions)\n      .then(rejectNonOK)\n      .then(res => res.json())\n      .then((res) => {\n        let responseValue = res;\n        if (onComplete) {\n          responseValue = dispatch(onComplete(responseValue));\n        }\n        dispatch(requestComplete(res, completedMeta));\n        return responseValue;\n      })\n      .catch((error) => {\n        if (onError) {\n          dispatch(onError(error));\n        }\n        dispatch(requestCompleteError(error, completedMeta));\n        throw error;\n      });\n  };\n}\n"]}