{"version":3,"sources":["actions/LoginActionCreators.js"],"names":["createDebug","INIT_STATE","SOCKET_CONNECT","SOCKET_RECONNECT","AUTH_STRATEGIES","REGISTER_START","REGISTER_COMPLETE","LOGIN_START","LOGIN_COMPLETE","SET_TOKEN","LOGOUT_START","LOGOUT_COMPLETE","RESET_PASSWORD_COMPLETE","LOAD_ALL_PLAYLISTS_START","Session","get","post","del","advance","loadHistory","setPlaylists","loadPlaylist","syncTimestamps","closeLoginDialog","tokenSelector","startTutorial","debug","socketConnect","type","socketReconnect","setAuthenticationStrategies","strategies","payload","loginComplete","token","socketToken","user","dispatch","loadedState","state","getState","booth","historyID","activePlaylist","initState","beforeTime","Date","now","onStart","onComplete","time","setSessionToken","loginStart","login","email","password","sessionType","preferredSessionType","set","res","meta","jwt","onError","error","register","username","grecaptcha","data","then","matchMedia","matches","logoutStart","logoutComplete","logout","unset","resetPassword","getSocketAuthToken","whenWindowClosed","window","Promise","resolve","i","setInterval","closed","clearInterval","socialLogin","service","apiUrl","config","loginWindow","open","loginWithGoogle"],"mappings":"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","sourcesContent":["import createDebug from 'debug';\nimport {\n  INIT_STATE,\n  SOCKET_CONNECT,\n  SOCKET_RECONNECT,\n  AUTH_STRATEGIES,\n  REGISTER_START,\n  REGISTER_COMPLETE,\n  LOGIN_START,\n  LOGIN_COMPLETE,\n  SET_TOKEN,\n  LOGOUT_START,\n  LOGOUT_COMPLETE,\n  RESET_PASSWORD_COMPLETE,\n  LOAD_ALL_PLAYLISTS_START,\n} from '../constants/ActionTypes';\nimport * as Session from '../utils/Session';\nimport { get, post, del } from './RequestActionCreators';\nimport { advance, loadHistory } from './BoothActionCreators';\nimport { setPlaylists, loadPlaylist } from './PlaylistActionCreators';\nimport { syncTimestamps } from './TickerActionCreators';\nimport { closeLoginDialog } from './DialogActionCreators';\nimport { tokenSelector } from '../selectors/userSelectors';\nimport startTutorial from '../_wlk/startTutorial';\n\nconst debug = createDebug('uwave:actions:login');\n\nexport function socketConnect() {\n  return { type: SOCKET_CONNECT };\n}\n\nexport function socketReconnect() {\n  return { type: SOCKET_RECONNECT };\n}\n\nexport function setAuthenticationStrategies(strategies) {\n  return {\n    type: AUTH_STRATEGIES,\n    payload: { strategies },\n  };\n}\n\nexport function loginComplete({ token, socketToken, user }) {\n  return (dispatch) => {\n    dispatch({\n      type: LOGIN_COMPLETE,\n      payload: {\n        token,\n        socketToken,\n        user,\n      },\n    });\n    dispatch(closeLoginDialog());\n  };\n}\n\nexport function loadedState(state) {\n  return (dispatch, getState) => {\n    dispatch({\n      type: INIT_STATE,\n      payload: state,\n    });\n    if (state.booth && state.booth.historyID) {\n      // TODO don't set this when logging in _after_ entering the page?\n      dispatch(advance(state.booth));\n    }\n    if (state.user) {\n      const token = tokenSelector(getState());\n      dispatch(loginComplete({\n        token,\n        socketToken: state.socketToken,\n        user: state.user,\n      }));\n    }\n    if (state.activePlaylist) {\n      dispatch(loadPlaylist(state.activePlaylist));\n    }\n  };\n}\n\nexport function initState() {\n  const beforeTime = Date.now();\n\n  return get('/now', {\n    onStart: () => ({ type: LOAD_ALL_PLAYLISTS_START }),\n    onComplete: state => (dispatch) => {\n      dispatch(syncTimestamps(beforeTime, state.time));\n      dispatch(loadedState(state));\n      dispatch(loadHistory());\n    },\n  });\n}\n\nexport function setSessionToken(token) {\n  return {\n    type: SET_TOKEN,\n    payload: { token },\n  };\n}\n\nfunction loginStart() {\n  return { type: LOGIN_START };\n}\n\nexport function login({ email, password }) {\n  const sessionType = Session.preferredSessionType();\n  return post(`/auth/login?session=${sessionType}`, { email, password }, {\n    onStart: loginStart,\n    onComplete: res => (dispatch) => {\n      Session.set(res.meta.jwt);\n      dispatch(setSessionToken(res.meta.jwt));\n      dispatch(initState());\n    },\n    onError: error => ({\n      type: LOGIN_COMPLETE,\n      error: true,\n      payload: error,\n    }),\n  });\n}\n\nexport function register({\n  email, username, password, grecaptcha,\n}) {\n  return post('/auth/register', {\n    email, username, password, grecaptcha,\n  }, {\n    onStart: () => ({ type: REGISTER_START }),\n    onComplete: res => (dispatch) => {\n      const user = res.data;\n      debug('registered', user);\n      dispatch({\n        type: REGISTER_COMPLETE,\n        payload: { user },\n      });\n      dispatch(login({ email, password }))\n        .then(() => {\n          if (matchMedia('(min-width: 769px)').matches) {\n            return startTutorial();\n          }\n          return null;\n        });\n    },\n    onError: error => ({\n      type: REGISTER_COMPLETE,\n      error: true,\n      payload: error,\n    }),\n  });\n}\n\nfunction logoutStart() {\n  return { type: LOGOUT_START };\n}\n\nfunction logoutComplete() {\n  return (dispatch) => {\n    dispatch({ type: LOGOUT_COMPLETE });\n    dispatch(setPlaylists([]));\n  };\n}\n\nexport function logout() {\n  return del('/auth', {}, {\n    onStart: () => (dispatch) => {\n      dispatch(logoutStart());\n      Session.unset();\n    },\n    onComplete: logoutComplete,\n  });\n}\n\nexport function resetPassword(email) {\n  return post('/auth/password/reset', email, {\n    onComplete: () => ({\n      type: RESET_PASSWORD_COMPLETE,\n      payload: 'Successfully sent password reset email',\n    }),\n    onError: error => ({\n      type: RESET_PASSWORD_COMPLETE,\n      error: true,\n      payload: error,\n    }),\n  });\n}\n\nexport function getSocketAuthToken() {\n  return get('/auth/socket', {\n    onComplete: res => () => ({\n      socketToken: res.data.socketToken,\n    }),\n  });\n}\n\nfunction whenWindowClosed(window) {\n  return new Promise((resolve) => {\n    const i = setInterval(() => {\n      if (window.closed) {\n        clearInterval(i);\n        resolve();\n      }\n    }, 50);\n  });\n}\nfunction socialLogin(service) {\n  return (dispatch, getState) => {\n    const { apiUrl } = getState().config;\n    const loginWindow = window.open(`${apiUrl}/auth/service/${service}`);\n    return whenWindowClosed(loginWindow).then(() => {\n      // Check login state after the window closed.\n      dispatch(initState());\n    });\n  };\n}\nexport function loginWithGoogle() {\n  return socialLogin('google');\n}\n"],"file":"LoginActionCreators.js"}